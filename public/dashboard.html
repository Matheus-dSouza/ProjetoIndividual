<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="js/sessao.js"></script>
</head>

<div class="navbar">
    <a href="index.html">Início</a>
    <a href="cadastro.html">Cadastro</a>
    <a href="#"><img id="navbar-icon"></a>
    <a href="login.html">Login</a>
    <a class="active" href="dashboard.html">Dashboard</a>
</div>

<body onload="validarSessao(), listarRank(), atualizarFeed()" id="dashboard-body">
    <div id="div-sessao">
        <h3>Olá, <span id="b_usuario"></span></h3>
        <div class="btn-logout" onclick="limparSessao()">
            <h3>Sair</h3>
        </div>
    </div>
    <div id="div_ranking_titulo">Ranking de Heróis</div>
    <div id="div_ranking">
        <div id="div_heroi"></div>
        <div id="div_votos"></div>
    </div>
    <div class="comentarios">
        <div class="container">
            <h1>Seção de Comentários</h1>
            <div id="feed_container" class="feed-container">
            </div>
        </div>
        <div class="div-form">
            <h1>Comentar</h1>
            <form id="form_postagem" method="post" onsubmit="return publicar()">
                <label>
                    Título do comentário:
                    <br>
                    <input name="titulo" id="titulo" maxlength="100" type="text">
                </label>
                <br>
                <br>
                <label>
                    Conteúdo (máximo de 250 caracteres):
                    <br>
                    <textarea name="descricao" id="textarea_descricao" maxlength="250" rows="5"></textarea>
                </label>
                <br>
                <br>
                <button>Enviar</button>
            </form>
        </div>
    </div>
</body>

<script>

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    function listarRank() {
        fetch(`/dashboard/listarRank`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            if (response.ok) {
                response.json().then(function (response) {
                    for (let i = 0; i < response.length; i++) {
                        div_heroi.innerHTML += `${response[i].Herói} <br>`
                        div_votos.innerHTML += `${response[i].Votos} votos <br>`
                    }
                })
            }
        }).catch(function (response) {
            console.log(`#ERRO: ${response}`);
        })
    }

    function limparFormulario() {
        document.getElementById("form_postagem").reset();
    }

    function publicar() {
        var idUsuario = sessionStorage.ID_USUARIO;

        var corpo = {
            titulo: form_postagem.titulo.value,
            conteudo: form_postagem.descricao.value
        }

        fetch(`/dashboard/publicar/${idUsuario}`, {
            method: "post",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(corpo)
        }).then(function (resposta) {
            console.log(resposta);
            if (resposta.ok) {
                window.alert("Post realizado com sucesso pelo usuario de ID: " + idUsuario + "!");
                limparFormulario();
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
            atualizarFeed();
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
        return false;
    }

    function deletar(idComentario) {
        console.log("Criar função de apagar post escolhido - ID" + idComentario);
        fetch(`/dashboard/deletar/${idComentario}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            if (resposta.ok) {
                window.alert("Post deletado com sucesso pelo usuario de email: " + sessionStorage.getItem("EMAIL_USUARIO") + "!");
                window.location = "/dashboard/mural.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function atualizarFeed() {
        fetch("/dashboard/listar").then(function (resposta) {
            console.log(resposta)
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));
                    var feed = ``

                    for (let i = resposta.length - 1; i >= 0; i--) {
                        feed += `Comentário #${resposta[i].id} // Usuário: ${resposta[i].usuario} <br> ${resposta[i].conteudo} <br> <br>`
                    }

                    feed_container.innerHTML = `${feed}`
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

</script>

</html>